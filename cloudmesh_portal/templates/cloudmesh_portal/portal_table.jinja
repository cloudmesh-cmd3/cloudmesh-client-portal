{% extends 'cloudmesh_portal/layout/index.jinja' %}

{% block title %}
{{ title }}
{% endblock %}

{% block content %}

<style type="text/css">
{% include "cloudmesh_portal/layout/navbar.css" %}
</style>


<script type="text/javascript" charset="utf-8">


        var $j = jQuery.noConflict();

        $j(document).ready(function() {

        {% include "cloudmesh_portal/layout/jquery.cookie.js" %}

         var csrftoken = $.cookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $j('[data-toggle="tooltip"]').tooltip();


        $('#dictTable').DataTable({
           aLengthMenu: [
                [10, 20, 50, 100, 200, -1],
                [10, 20, 50, 100, 200, "All"]
            ],
            iDisplayLength: 10,
            responsive: true,
            });

        var table = $('#dictTable').DataTable();

        $j('#select-all').click(function () {
            $j(':checkbox', table.rows().nodes()).prop('checked', this.checked);
        });

        $('#terminate').click(function(){

              alert("You have confirmed to stop these VM's!");

        });

        $j('#delete').click(function(){

              alert("VM will persisted in the database!");

        });

        $j(".alert").fadeOut(8000);

        $j('.popover-link').each(function() {
            $j(this).popover({
                html: true,
                trigger: 'manual'
            }).click(function(e) {
            $j(this).popover('toggle');
            $j('.close').remove();
            $j('.popover-title').append('<button type="button" class="close">&times;</button>');
            $j('.close').click(function(e){
                $j(this).parents('.popover').remove();
            });
        });
        });



        $j('#custom_boot').click(function() {

          $.ajax({
            type: 'GET',
            url: 'vm_action/',
            cache: false,
            data: {},
            dataType: 'json',
            success: function(res) {

           console.log("RES"+res);

           $j('#cloud_name').val(res[0]);

           $j('#group_name').val(res[1]);

           $.each(res[2],function(key,image){

           $j('#image').append(
             '<option>'+
             image+
             '</option>'
            );
            });

           $.each(res[3],function(key,flavor){

           $j('#flavor').append(
             '<option>'+
             flavor+
             '</option>'
            );
            });
            }
        });
        }); //end of function


        $j('#custom_boot_vm').click(function() {

            $.ajax({
            url: 'vm_action/',
            contentType : 'application/json',
            dataType: 'json',
            type: 'POST',
            data: JSON.stringify( {"cloud_name": $('#cloud_name').val(), "vm_count": $('#vm_count').val(),
                                    "group": $('#group').val(), "image": $('#image').val() ,
                                    "flavor": $('#flavor').val() , "group_name": $('#group_name').val()
                                } ),
            success: function(data){

                   $j('#response').append(
                    '<div class="alert alert-success">'+
                    '<a href="#" class="close" data-dismiss="alert" aria-label="close">'+'</a>'+
                    '<strong>'
                    +data+
                    '</strong>'+
                   '</div>');
            }
            });

        $j('#modal_close').click(function(){
            $j('#response').html("");
            $j('#myModal').html("");
        });

        });

        }); //end of document ready

</script>


<ul class="list-unstyled messages">
  {% for message in get_messages(request) %}
    {% if message.tags == 'info' %}
        <div class="alert alert-info fade in">
         <a class="close" data-dismiss="alert" aria-label="close">&times;</a>
         <strong>{{ message }}</strong></div>
    {% elif message.tags == 'success' %}
        <div class="alert alert-success fade in">
        <a class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <strong>{{ message }}</strong></div>
    {% else %}
        <div class="alert alert-danger fade in">
        <a class="close" data-dismiss="alert" aria-label="close">&times;</a>
        <strong>{{ message }}</strong></div>
    {% endif %}
  {% endfor %}
</ul>

{% if 'vm' in request.path %}
<form action="vm_action/" method="post">
{% csrf_token %}

<table  id="dictTable" class="table table-bordered table-hover">
   <thead>
        <tr class="bg-info text-capitalize">
          <td>
          Select
          <input type="checkbox" id="select-all" class="checkbox"/>
          </td>
            {% if header %}
                {% for attribute in header %}
                        <th>{{ attribute }} </th>
                {% endfor %}
            {% else %}
                {% for attribute in order %}
                        <th>{{ attribute }} </th>
                {% endfor %}
            {% endif %}
        </tr>
    </thead>
    {% if data is mapping  %}
    <tbody>
        {% for element in data %}
        <tr>
            {% if 'vm' in request.path %}
            <td>
                    <div align="center">
                    <input type="checkbox" name="vm_id" value="{{ data[element].get('name') }}"/>
                    </div>
                    <div id="info_popover">

                    <a class="popover-link" rel='popover' data-placement='right'
                        data-container="#info_popover" data-toggle="tooltip" title="VM Information"
                        data-original-title='{{ data[element].get('label')}} VM Details'
                        data-content=
                        '&lt;p&gt;<b>SECURITY GROUP</b>    <br/>{{ data[element].get('security_groups')}}&lt;/p&gt;
                        &lt;p&gt;<b>KEY</b><br/> {{ data[element].get('key')}}&lt;p&gt;
                        &lt;p&gt;<b>LAUNCHED AT</b><br/> {{ data[element].get('launched_at')}}&lt;p&gt;
                        &lt;p&gt;<b>NAME</b><br/>{{ data[element].get('name')}}&lt;p&gt;
                        &lt;p&gt;<b>AVAILABILITY ZONE</b> <br/>{{ data[element].get('launched_at')}}&lt;/p&gt;
                        &lt;p&gt;<b>PROVIDER</b><br/> {{ data[element].get('provider')}}&lt;p&gt;
                        &lt;p&gt;<b>UPDATED AT</b> <br/>{{ data[element].get('updated_at')}}&lt;p&gt;'
                        >
                        <span class="glyphicon glyphicon-list-alt"></span>
                    </a>
                    </div>
                    <div>
                    <button type="submit" class="btn btn-link" data-placement="right" name="boot_vm"
                        data-toggle="tooltip" title="Click to Boot VM" value="{{ data[element].get('name') }}">
                      <span class="glyphicon glyphicon-cloud"></span>
                    </button>
                    </div>
            </td>
            {% endif %}
               {% for a in order %}
               <td>
                   {% if a in ["st","status", "avail", "state", "down", "active", "default"] %}
                        {{ state_color(data[element][a]) |safe }}
                   {% else %}
                        {{ data[element][a] | safe}}
                   {% endif %}
            {% endfor %}
               </td>
        </tr>
        {% endfor %}
    </tbody>



<nav class="navbar navbar-inverse" >
  <div class="container-fluid" id="navbar_container">
    <div class="navbar-header">
    <ul class="nav navbar-nav">
      {% if 'image' in request.path %}
            <a href="/cm/image/refresh" class="btn btn-info btn-lg">
            <span class="glyphicon glyphicon-refresh"></span> Refresh Data</a>
      {% elif 'flavor' in request.path %}
             <a href="/cm/flavor/refresh" class="btn btn-info btn-sm">
             <span class="glyphicon glyphicon-refresh"></span> Refresh Data</a>
      {% else %}
            </li>
            <a href="/cm/vm/refresh" class="btn btn-info btn-sm">
            <span class="glyphicon glyphicon-refresh"></span> Refresh Data</a>
            </li>
      {% endif %}
       <li>
        <button type="button" class="btn btn-success btn-sm" id="custom_boot" name="custom_vm_boot" data-toggle="modal" data-target="#myModal">
        <span class="glyphicon glyphicon-cloud"></span> Boot VM
        </button>
      </li>
      <li>
        <button type="submit" class="btn btn-info btn-sm" name="start_vm">
        <span class="glyphicon glyphicon-play"></span> Start VM
        </button>
      </li>
      <li>
        <button type="submit" class="btn btn-warning btn-sm" id="stop" name="stop_vm">
        <span class="glyphicon glyphicon-stop"></span> Stop VM
        </button>
      </li>
      <li>
        <button type="submit" class="btn btn-danger btn-sm" id="delete" name="delete_vm">
        <span class="glyphicon glyphicon-trash"></span> Delete VM
        </button>
      </li>
      </ul>
    </div>
</nav>
</table>

 <div id="asd">
           <div id="myModal" class="modal fade" role="dialog">
           <div class="modal-dialog">
             <div class="modal-content">
               <div class="modal-header">
                 <h4 class="modal-title">Custom VM Boot</h4>
               </div>
               <div class="modal-body">
          <div id="response">
          </div>
          <div class="form-group">
          <label class="control-label">Cloud</label>
          <input type="text" class="form-control" id="cloud_name">
          </div>
          <div class="form-group">
          <label class="control-label">Number of VM Instances</label>
          <input type="text" class="form-control" id="vm_count" value="1">
          </div>
          <div class="form-group">
          <label class="control-label"><b>Group</b></label>
          <input type="text" class="form-control" id="group_name">
          </div>
          <div class="form-group">
          <label class="control-label">Image</label>
          <select class="selectpicker" id="image">
          </select>
          </div>
          <div class="form-group">
          <label class="control-label">Flavor</label>
          <select class="selectpicker" id="flavor">
          </select>
          </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal" id="modal_close">Close</button>
                  <button type="button" class="btn btn-success" id="custom_boot_vm">Boot VM</button>
                </div>
              </div>
            </div>
          </div>

 </div>
{% endif %}

{% endif %}
{% endblock %}
